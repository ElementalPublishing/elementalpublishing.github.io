<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Button Debug - Elemental Publishing</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- PayPal Checkout SDK - Sandbox Mode -->
    <script src="https://www.sandbox.paypal.com/sdk/js?client-id=AWWCzMohcrFfVJkA2V02yU1GjPZ7cetRnXNF-_OVlJZx_yHZICTQmeOhqHgDUzyjIZYhrwdevxy65_6y&currency=USD&intent=capture"></script>
</head>
<body style="padding: 2rem;">
    <h1>Button Debug Test</h1>
    
    <div style="margin: 2rem 0; padding: 1rem; border: 1px solid #ddd;">
        <h3>Strip Tape Test</h3>
        <div id="paypal-button-striptape" class="paypal-button-container" style="border: 2px solid red; padding: 10px;">
            <!-- Fallback button while PayPal loads -->
            <button class="btn btn-small btn-secondary fallback-buy-btn" onclick="buyAlbum('striptape')" style="background: orange; padding: 10px;">Buy Direct - $15 (FALLBACK)</button>
        </div>
    </div>
    
    <div id="debug-log" style="margin-top: 2rem; padding: 1rem; background: #f5f5f5; border: 1px solid #ccc;">
        <h4>Debug Log:</h4>
        <div id="log-content"></div>
    </div>

    <script>
        // Debug logging
        function debugLog(message) {
            console.log(message);
            const logDiv = document.getElementById('log-content');
            logDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
        }

        // Album data
        const albumData = {
            'striptape': {
                name: 'Strip Tape', 
                price: '15.00',
                downloadPage: 'download-striptape.html',
                thankYouPage: 'thank-you-striptape.html'
            }
        };

        function buyAlbum(albumKey) {
            debugLog('buyAlbum called with: ' + albumKey);
            const album = albumData[albumKey];
            
            if (!album) {
                debugLog('ERROR: Album not found for key: ' + albumKey);
                alert('Album not found: ' + albumKey);
                return;
            }
            
            // Redirect to download page with fallback flag
            const url = album.downloadPage + '?payment=fallback';
            debugLog('Redirecting to: ' + url);
            window.location.href = url;
        }

        // Create PayPal buttons for each album
        function createPayPalButton(albumKey, containerId) {
            debugLog('Creating PayPal button for: ' + albumKey + ' in container: ' + containerId);
            const album = albumData[albumKey];
            const container = document.getElementById(containerId);
            
            if (!container) {
                debugLog('ERROR: Container not found: ' + containerId);
                return;
            }
            
            if (!album) {
                debugLog('ERROR: Album data not found for: ' + albumKey);
                return;
            }
            
            debugLog('Container found, album data: ' + JSON.stringify(album));
            
            paypal.Buttons({
                style: {
                    layout: 'horizontal',
                    color: 'blue',
                    shape: 'rect',
                    label: 'pay',
                    height: 35
                },
                createOrder: function(data, actions) {
                    debugLog('PayPal createOrder called for: ' + album.name);
                    
                    return actions.order.create({
                        purchase_units: [{
                            description: album.name + ' - High Quality MP3 Album',
                            amount: {
                                currency_code: 'USD',
                                value: album.price
                            }
                        }]
                    });
                },
                onApprove: function(data, actions) {
                    debugLog('PayPal onApprove called');
                    return actions.order.capture().then(function(orderData) {
                        debugLog('Payment completed: ' + JSON.stringify(orderData));
                        
                        // Redirect to download page
                        const url = album.downloadPage + '?payment=success&order=' + orderData.id;
                        debugLog('Redirecting to: ' + url);
                        window.location.href = url;
                    });
                },
                onError: function(err) {
                    debugLog('PayPal error: ' + JSON.stringify(err));
                    alert('Payment failed. Please try again.');
                },
                onCancel: function(data) {
                    debugLog('Payment cancelled: ' + JSON.stringify(data));
                }
            }).render('#' + containerId).then(function() {
                debugLog('PayPal button rendered successfully in: ' + containerId);
                const fallbackBtn = container.querySelector('.fallback-buy-btn');
                if (fallbackBtn) {
                    fallbackBtn.style.display = 'none';
                    debugLog('Hid fallback button for: ' + containerId);
                }
            }).catch(function(err) {
                debugLog('PayPal render error for ' + containerId + ': ' + JSON.stringify(err));
                const fallbackBtn = container.querySelector('.fallback-buy-btn');
                if (fallbackBtn) {
                    fallbackBtn.style.display = 'inline-block';
                    debugLog('Kept fallback button visible due to render error');
                }
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM loaded, starting initialization...');
            
            // Ensure fallback buttons are visible immediately
            document.querySelectorAll('.fallback-buy-btn').forEach(btn => {
                btn.style.display = 'inline-block';
                btn.style.visibility = 'visible';
                debugLog('Made fallback button visible on load');
            });
            
            function checkAndInitPayPal() {
                debugLog('Checking PayPal SDK...');
                debugLog('PayPal object type: ' + typeof paypal);
                debugLog('Window.paypal exists: ' + (!!window.paypal));
                
                if (typeof paypal !== 'undefined' && paypal && paypal.Buttons) {
                    debugLog('PayPal SDK loaded successfully, creating buttons...');
                    try {
                        createPayPalButton('striptape', 'paypal-button-striptape'); 
                        debugLog('PayPal button creation completed');
                    } catch (error) {
                        debugLog('Error creating PayPal buttons: ' + error.message);
                    }
                } else {
                    debugLog('PayPal SDK not loaded. Using fallback buttons.');
                }
            }
            
            // Try immediately
            checkAndInitPayPal();
            
            // Try again after 2 seconds
            setTimeout(function() {
                debugLog('--- Retry after 2 seconds ---');
                checkAndInitPayPal();
            }, 2000);
        });
    </script>
</body>
</html>
